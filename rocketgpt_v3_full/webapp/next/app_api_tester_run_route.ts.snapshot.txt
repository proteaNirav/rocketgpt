// app/api/tester/run/route.ts
// Dev-mode stub implementation for Tester Runner
// - Validates payload shape
// - Does NOT touch Supabase or rgpt_builds
// - Returns a fake but realistic success response for wiring & demos

import { NextRequest, NextResponse } from "next/server";

export const dynamic = "force-dynamic";

type TesterRunPayload = {
  runId: number;
  buildId: number;
  testFiles: string[];
  environment?: string;
};

function badRequest(message: string) {
  return NextResponse.json(
    {
      success: false,
      error: "InvalidPayload",
      message,
    },
    { status: 400 }
  );
}

export async function POST(req: NextRequest) {
  try {
    const body = (await req.json()) as Partial<TesterRunPayload>;

    const { runId, buildId, testFiles, environment } = body;

    // Basic validations to match what we discovered from error messages
    if (typeof runId !== "number") {
      return badRequest("runId (number) is required.");
    }

    if (typeof buildId !== "number") {
      return badRequest("buildId (number) is required.");
    }

    if (!Array.isArray(testFiles) || testFiles.length === 0) {
      return badRequest("testFiles must be a non-empty string array.");
    }

    if (!testFiles.every((f) => typeof f === "string")) {
      return badRequest("testFiles must contain only strings.");
    }

    // ==== DEV-MODE STUB START =========================================
    // In this stub, we DO NOT:
    // - call Supabase
    // - read rgpt_builds
    // - call any external tester service
    //
    // Instead, we simulate a successful test run so that:
    // - Orchestrator wiring can be tested end-to-end
    // - UI can display test results
    // - You are unblocked while DB schema is incomplete

    const now = Date.now();
    const testRunId = `local-testrun-${runId}-${buildId}-${now}`;

    const results = testFiles.map((file) => ({
      test_case: file,
      status: "passed",
      error: null as string | null,
      duration_ms: 10,
    }));

    const logs: string[] = [
      `Dev stub tester run at ${new Date(now).toISOString()}`,
      `runId=${runId}, buildId=${buildId}, environment=${environment ?? "n/a"}`,
      `Executed ${testFiles.length} test file(s): ${testFiles.join(", ")}`,
    ];

    const responseBody = {
      success: true,
      test_run_id: testRunId,
      status: "success",
      summary: "Dev-mode stub: test execution completed successfully (no real tests run).",
      results,
      logs,
      artifacts: [] as any[],
    };

    return NextResponse.json(responseBody, { status: 200 });
    // ==== DEV-MODE STUB END ===========================================
  } catch (err) {
    console.error("[TesterRun] Unexpected error:", err);
    return NextResponse.json(
      {
        success: false,
        error: "TesterRunUnexpectedError",
        message: "Unexpected error while running tests (dev stub).",
      },
      { status: 500 }
    );
  }
}

