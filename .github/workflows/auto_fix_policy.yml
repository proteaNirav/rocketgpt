name: Self-Improve

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      reason:
        description: Why run self-improve?
        required: false
        default: bootstrap

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  route:
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.issue.labels.*.name, 'self-improve') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Decide next action (pwsh)
        id: plan
        shell: pwsh
        run: |
          # For now, always trigger auto-fix policy workflow via workflow_run API comment
          Write-Host "plan=auto_fix_policy" >> $env:GITHUB_OUTPUT

      - name: Trigger auto_fix_policy via repository_dispatch
        if: steps.plan.outputs.plan == 'auto_fix_policy'
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: auto_fix_policy_requested
          client-payload: '{"source":"self_improve"}'
