name: AI Review (read-only)
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  pull-requests: write
  contents: read
jobs:
  review:
    if: "${{ github.event.pull_request.head.repo.full_name == github.repository }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Generate diff summary
        id: diff
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1
          echo "DIFF<<EOF" >> ${GITHUB_OUTPUT}
          git --no-pager diff --unified=0 origin/"${{ github.base_ref }}"...HEAD | head -n 4000 >> ${GITHUB_OUTPUT}
          echo "EOF" >> ${GITHUB_OUTPUT}

      - name: Post placeholder review comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "ðŸ¤– **AI Pre-Review** (placeholder)",
              "",
              "- No external calls were made.",
              "- Add `CLAUDE_API_KEY` later to enable full AI diff analysis.",
              "",
              "<details><summary>First 200 lines of diff (truncated)</summary>\n\n```diff\n" +
              (process.env.DIFF || "").split("\n").slice(0,200).join("\n") +
              "\n```\n</details>"
            ].join("\n");
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })
        env:
          DIFF: "${{ steps.diff.outputs.DIFF }}"
      - name: Upload AI log artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-log
          path: .rocket/logs/ai-review.json
          if-no-files-found: ignore
