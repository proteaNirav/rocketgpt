name: AI CI-Failure Advisor

on:
  workflow_run:
    workflows:
      - "Validate (lint + typecheck + test)"
      - "Security Scan (deps + secrets)"
      - "ci"
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  advise:
    # Run only on PR runs that failed AND the PR has label ai:advisor
    if: >
      ${{
        (github.event.workflow_run.event == 'pull_request') &&
        (github.event.workflow_run.conclusion == 'failure' ||
         github.event.workflow_run.conclusion == 'timed_out' ||
         github.event.workflow_run.conclusion == 'cancelled')
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR info from workflow_run
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            if (!run.pull_requests || run.pull_requests.length === 0) {
              core.setFailed("No associated PR found for this run.");
              return;
            }
            const pr = run.pull_requests[0];
            core.setOutput('number', pr.number.toString());
            core.setOutput('run_id', run.id.toString());
            core.setOutput('head_sha', run.head_sha);

      - name: Check PR label gate
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const number = parseInt(core.getInput('number') || '${{ steps.pr.outputs.number }}', 10);
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number
            });
            const has = labels.some(l => l.name === 'ai:advisor');
            core.setOutput('allowed', has ? 'true' : 'false');

      - name: Exit if not labeled
        if: steps.gate.outputs.allowed != 'true'
        run: echo "ai:advisor label missing; skipping."

      - name: Download logs for the failed run
        if: steps.gate.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          run_id="${{ steps.pr.outputs.run_id }}"
          curl -L \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${run_id}/logs" \
            -o logs.zip
          mkdir logs && unzip -q logs.zip -d logs
          find logs -type f -name "*.txt" -exec sh -c 'echo ":: file: $1 ::"; tail -n 400 "$1"' _ {} \; > logs_tail.txt || true
          if [ ! -s logs_tail.txt ]; then echo "No logs extracted." > logs_tail.txt; fi

      - name: Call Claude for triage summary and fixes
        if: steps.gate.outputs.allowed == 'true'
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          set -e
          cat > prompt.txt <<'EOF'
You are an expert CI triage assistant. Given CI logs (tail, truncated), produce:
- Summary
- Root Causes
- Suggested Fixes (short patches)
- Next Steps
If secrets are exposed: mark [SECURITY] and advise revoke/rotate.
EOF
          echo -e "\n--- CI LOG TAIL (truncated) ---\n" >> prompt.txt
          head -c 250000 logs_tail.txt >> prompt.txt

          body=$(jq -Rs --arg model "claude-3-5-sonnet-latest" '{model:$model, max_tokens:2000, messages:[{role:"user", content:.}]}' prompt.txt)
          curl -sS https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$body" > claude.json

          jq -r '
            if .content and (.content|length>0) and .content[0].type=="text"
            then .content[0].text
            else "Claude response parsing error:\n" + (tostring)
            end
          ' claude.json > advice.md

      - name: Post advice as PR comment
        if: steps.gate.outputs.allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const number = parseInt('${{ steps.pr.outputs.number }}', 10);
            const text = fs.readFileSync('advice.md', 'utf8');
            const header = [
              "### üõ†Ô∏è CI Failure Advisor",
              "",
              "- Workflow: `" + context.payload.workflow_run.name + "`",
              "- Conclusion: `" + context.payload.workflow_run.conclusion + "`",
              "- Run ID: `" + context.payload.workflow_run.id + "`",
              "",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: header + "\n" + text
            });

      - name: Upload artifacts
        if: steps.gate.outputs.allowed == 'true'
        uses: actions/upload-artifact@v4
@v4
        with:
          name: ai-ci-advisor-artifacts
          path: |
            logs_tail.txt
            prompt.txt
            claude.json
            advice.md
          if-no-files-found: ignore

