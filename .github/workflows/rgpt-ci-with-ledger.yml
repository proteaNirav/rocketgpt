name: rgpt-ci-with-ledger

on:
  push:
  pull_request:
jobs:
  build_test:
    name: Build + Test (placeholder)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Replace this with your real CI steps (pnpm test, playwright, etc.)
      - name: Placeholder (fails if marker exists)
      # This is intentionally safe; it only fails if a file exists.
        run: |
          if [ -f ".rgpt_force_fail_ci" ]; then
            echo "Forced failure marker detected."
            exit 1
          fi
          echo "CI placeholder passed."

  ingest_on_failure:
    name: Ingest failure → Self-Improve Ledger
    needs: [build_test]
    if: ${{ always() && needs.build_test.result == 'failure' }}
    uses: ./.github/workflows/_selfimprove_ingest_ci.yml
    secrets: inherit
    with:
      phase: "S1"
      subsystem: "ci"
      signal_type: "failure"
      severity: "high"
      recommendation: "Review CI failure logs, classify root-cause, and add a deterministic guard/test to prevent recurrence."

