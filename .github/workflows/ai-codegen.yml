name: AI Codegen

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: codegen-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  codegen:
    if: contains(github.event.issue.labels.*.name, 'codegen:ready')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build plan
        run: |
          mkdir -p .rocketgpt/ai
          echo "# Plan for: ${{ github.event.issue.title }}" > .rocketgpt/ai/issue-${{ github.event.issue.number }}.md
          echo "- Labels: ${{ toJson(github.event.issue.labels.*.name) }}" >> .rocketgpt/ai/issue-${{ github.event.issue.number }}.md
          echo >> .rocketgpt/ai/issue-${{ github.event.issue.number }}.md
          echo "${{ github.event.issue.body }}" >> .rocketgpt/ai/issue-${{ github.event.issue.number }}.md
      - name: Commit + PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: feature/issue-${{ github.event.issue.number }}
          title: AI Codegen: ${{ github.event.issue.title }}
          body: Auto-created by AI Codegen.
          commit-message: ci: add AI plan for issue #${{ github.event.issue.number }}
          add-paths: .rocketgpt/ai/issue-${{ github.event.issue.number }}.md
          title-prefix: ''
