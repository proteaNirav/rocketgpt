name: Vercel Throttled Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - name: Decide if deploy allowed (30 min gate)
        id: decide
        uses: actions/github-script@v7
        with:
          script: |
            const THROTTLE_SECONDS = 1800; // 30 min
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // Find THIS workflow's id by name (GITHUB_WORKFLOW)
            const { data: { workflows } } = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const wf = workflows.find(w => w.name === process.env.GITHUB_WORKFLOW);
            if (!wf) {
              core.setOutput('allowed', 'true'); // be permissive if we can't find it
              core.info('Workflow id not found, allowing deploy.');
              return;
            }

            // Get recent completed runs for this workflow
            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRuns({
              owner, repo, workflow_id: wf.id, per_page: 10, status: 'completed'
            });

            // Find most recent SUCCESS
            const lastSuccess = workflow_runs.find(r => r.conclusion === 'success');
            if (!lastSuccess) {
              core.setOutput('allowed', 'true');
              core.info('No successful runs found yet — allowing deploy.');
              return;
            }

            const last = Date.parse(lastSuccess.updated_at);
            const now  = Date.now();
            const diffSeconds = Math.floor((now - last) / 1000);

            core.info(`Time since last successful deploy: ${diffSeconds}s`);

            if (diffSeconds < THROTTLE_SECONDS) {
              core.setOutput('allowed', 'false');
              core.setOutput('last_updated', lastSuccess.updated_at);
              core.info('Under 30 minutes — skip deploy.');
            } else {
              core.setOutput('allowed', 'true');
              core.info('Over 30 minutes — allow deploy.');
            }

      - name: Trigger Vercel Deployment via Deploy Hook
        if: steps.decide.outputs.allowed == 'true'
        run: |
          echo "Deploying to Vercel via deploy hook..."
          curl -sS -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}"
          echo "Triggered."
      - name: Skip notice
        if: steps.decide.outputs.allowed != 'true'
        run: |
          echo "Skipping deploy: last successful deploy was within 30 minutes."
