name: status_context_bridge

on:
  push:
    branches:
      - main
  workflow_run:
    workflows:
      - ci
      - text-guard (smoke)
      - policy_gate_aggregator
    types:
      - completed

permissions:
  statuses: write
  actions: read
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Publish required status contexts
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            const sha = run.head_sha;
            const path = (run.path || "").toLowerCase();
            const name = (run.name || "").toLowerCase();
            const conclusion = (run.conclusion || "").toLowerCase();

            // Only completed workflow_run events should publish a commit status
            if (run.status !== "completed") {
              core.info(`Workflow not completed yet: ${run.status}`);
              return;
            }

            // Map workflow_run conclusion -> commit status state
            let state = "failure";
            if (conclusion === "success") state = "success";
            if (conclusion === "skipped") state = "success"; // neutral-safe for required contexts

            // Determine target required STATUS context
            let targetContext = null;

            // Prefer mapping by workflow *name* (most stable)
            if (name.includes("smoke")) targetContext = "smoke";
            else if (name.includes("policy_gate_aggregator") || name.includes("policy gate") || name.includes("policy_gate")) targetContext = "policy_gate";
            else if (name === "ci" || name.includes("build-test") || name.includes("build test")) targetContext = "build-test";

            // Fallback mapping by file path (secondary)
            if (!targetContext) {
              if (path.endsWith("ci.yml") || path.endsWith("ci.yaml")) targetContext = "build-test";
              else if (path.includes("policy_gate_aggregator") || path.includes("policy_gate_required")) targetContext = "policy_gate";
              else if (path.includes("smoke")) targetContext = "smoke";
            }

            if (!targetContext) {
              core.info(`No required context mapping for workflow: name='${run.name}' path='${run.path}'`);
              return;
            }

            core.info(`Publishing status context '${targetContext}' for ${sha}: ${state}`);

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state,
              context: targetContext,
              description: `Bridge: ${run.name} â†’ ${state}`,
              target_url: run.html_url
            });

