name: Watchdog

on:
  workflow_run:
    workflows: ["AI Codegen", "RocketGPT Ship Issue", "v4_ship_placeholder"]
    types: [completed]

jobs:
  watch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Gate by safety policy (dry check)
        uses: actions/github-script@v7
        with:
          script: |
            core.info('Watchdog observing: ' + context.workflow);
            core.info('Conclusion: ' + context.payload.workflow_run.conclusion);

      - name: On failure — auto redispatch limited
        if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'cancelled' || github.event.workflow_run.conclusion == 'timed_out' }}
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const wfName = run.name;
            core.info(`Workflow '${wfName}' failed; scheduling a single redispatch of AI Codegen as a nudge.`);
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "codegen.yml",
                ref: "main",
                inputs: { issue_number: "110" }
              });
            } catch (e) {
              core.warning('Redispatch failed: ' + e.message);
            }