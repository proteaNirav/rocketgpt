name: watchdog

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["AI Codegen", "RocketGPT Ship Issue"]
    types: [completed]

jobs:
  watch:
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Observe
        uses: actions/github-script@v7
        with:
          script: |
            const wr = context.payload.workflow_run;
            if (wr) {
              core.info('Observed run: ' + (wr.name ?? '<no-name>'));
              core.info('Conclusion: ' + (wr.conclusion ?? '<no-conclusion>'));
              core.info('Workflow URL: ' + (wr.html_url ?? '<no-url>'));
            } else {
              core.info('Manual watchdog run (workflow_dispatch). No workflow_run payload present.');
              core.info('Actor: ' + (context.actor ?? '<unknown>'));
              core.info('Ref: ' + (process.env.GITHUB_REF ?? '<unknown>'));
              core.info('SHA: ' + (process.env.GITHUB_SHA ?? '<unknown>'));
            }
      - name: On failure - minimal redispatch
        if: ${{ contains(fromJson('["failure","cancelled","timed_out"]'), github.event.workflow_run.conclusion) }}
        uses: actions/github-script@v7
        with:
          script: |
            const defaultIssue = process.env.DEFAULT_ISSUE || "110";
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "codegen.yml",
                ref: "main",
                inputs: { issue_number: String(defaultIssue) }
              });
              core.info('Redispatched AI Codegen for #' + defaultIssue);
            } catch (e) {
              core.warning('Redispatch failed: ' + e.message);
            }



