name: Branch Sync (main to develop)
on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "15 * * * *"
permissions:
  contents: write
  pull-requests: write
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check divergence and open PR if needed
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // 1) Make sure develop exists
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: "develop" });
            } catch {
              core.setFailed("Branch 'develop' not found.");
              return;
            }

            // 2) If a sync PR is already open, stop
            const existing = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: "open",
              base: "develop",
              per_page: 100
            });
            const found = existing.find(p => p.title.includes("chore: sync main → develop"));
            if (found) {
              core.notice(`Sync PR already open: #${found.number}`);
              return;
            }

            // 3) Try to create the PR – but handle 403 as a WARNING, not a failure
            const title = "chore: sync main → develop";
            const body  = "Automated sync: bring main-only commits into develop.";
            let pr;
            try {
              const response = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: "main",
                base: "develop",
                body,
                maintainer_can_modify: true,
                draft: false
              });
              pr = response.data;
            } catch (e) {
              if (e.status === 403) {
                core.warning(`Branch Sync: GitHub Actions is not permitted to create PRs. Skipping sync. ${e.message}`);
                return;
              }
              core.setFailed(`Branch Sync: unexpected error while creating sync PR: ${e.message}`);
              return;
            }

            // 4) Label + auto-merge (best-effort)
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ["ai:auto-merge"]
            });

            try {
              const prQ = await github.graphql(
                `query($o:String!,$n:String!,$num:Int!){repository(owner:$o,name:$n){pullRequest(number:$num){id}}}`,
                { o: owner, n: repo, num: pr.number }
              );
              await github.graphql(
                `mutation($pr:ID!){ enablePullRequestAutoMerge(input:{ pullRequestId:$pr, mergeMethod:SQUASH }){ clientMutationId } }`,
                { pr: prQ.repository.pullRequest.id }
              );
              core.notice(`Opened + auto-merge enabled for PR #${pr.number}`);
            } catch (e) {
              core.warning(`Opened PR #${pr.number}, but auto-merge not enabled: ${e.message}`);
            }
