name: rgpt-db-exposure-guard

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  statuses: write
  contents: read

jobs:
  rgpt-db-exposure-guard:
    # Run on push/main + workflow_dispatch always.
    # On PRs, run only for same-repo branches (fork PRs don't get secrets).
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0
      - name: Install psql
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run rgpt schema exposure guard (must return zero rows)
        shell: pwsh
        env:
          SUPABASE_DB_POOLER_URL: ${{ secrets.SUPABASE_DB_POOLER_URL }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          $ErrorActionPreference = "Stop"

          # Fork PRs do not receive secrets; skip cleanly to avoid noisy failures
          if (-not $env:SUPABASE_DB_POOLER_URL) {
            if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
              Write-Host "[SKIP] SUPABASE_DB_POOLER_URL not available for fork PRs." -ForegroundColor Yellow
              exit 0
            }
            throw "Missing SUPABASE_DB_POOLER_URL"
          }

          $url = $env:SUPABASE_DB_POOLER_URL.Trim()
          $sqlFile = "docs/ops/guards/rgpt_schema_exposure_assert.sql"
          if (-not (Test-Path $sqlFile)) { throw "Missing SQL guard file: $sqlFile" }

          Write-Host "[RUN] Guard SQL: $sqlFile" -ForegroundColor Cyan

          try { $u = [System.Uri]::new($url) } catch { throw "Invalid SUPABASE_DB_POOLER_URL format" }
          $pgHost = $u.Host

          # Resolve IPv4 (optional) to avoid any DNS/AAAA quirks on runners
          $ipv4 = $null
          try {
            $line = (getent ahostsv4 $pgHost | Select-Object -First 1)
            if ($line) { $ipv4 = ($line -split "\s+")[0] }
          } catch { }

          if ($ipv4) {
            Write-Host "[INFO] IPv4 resolved: $pgHost -> $ipv4" -ForegroundColor Green
            $env:PGHOSTADDR = $ipv4
          } else {
            Write-Host "[WARN] IPv4 not resolved for $pgHost (will use hostname)" -ForegroundColor Yellow
          }

          $port = if ($u.Port -gt 0) { $u.Port } else { 5432 }
          $db   = $u.AbsolutePath.TrimStart("/")
          if (-not $db) { throw "Database name missing in SUPABASE_DB_POOLER_URL" }
          $userInfo = $u.UserInfo
          $user = $null
          $pass = $null
          $passSource = "none"   # url | secret | none

          if (-not [string]::IsNullOrWhiteSpace($userInfo)) {
            # userInfo can be "user:pass" OR just "user"
            $parts = $userInfo.Split(":", 2)
            $user = [Uri]::UnescapeDataString($parts[0])

            if ($parts.Count -ge 2 -and -not [string]::IsNullOrWhiteSpace($parts[1])) {
              $pass = [Uri]::UnescapeDataString($parts[1])
              $passSource = "url"
            }
          }
          if ([string]::IsNullOrWhiteSpace($user)) {
            if (-not [string]::IsNullOrWhiteSpace($env:SUPABASE_DB_USER)) {
              $user = $env:SUPABASE_DB_USER
              Write-Host "[INFO] Using SUPABASE_DB_USER secret for username (URL contained no user)." -ForegroundColor Yellow
            } else {
              throw "User missing in SUPABASE_DB_POOLER_URL and SUPABASE_DB_USER not provided"
            }
          }
          # If URL does not contain password, use SUPABASE_DB_PASSWORD secret
          if ([string]::IsNullOrWhiteSpace($pass)) {
            if (-not [string]::IsNullOrWhiteSpace($env:SUPABASE_DB_PASSWORD)) {
              $pass = $env:SUPABASE_DB_PASSWORD
              $passSource = "secret"
              Write-Host "[INFO] Using SUPABASE_DB_PASSWORD secret for password (URL contained no password)." -ForegroundColor Yellow
            } else {
              throw "Password missing in SUPABASE_DB_POOLER_URL and SUPABASE_DB_PASSWORD not provided"
            }
          }          # Create .pgpass so password is not in args/logs
          $pgpassPath = Join-Path $env:RUNNER_TEMP ".pgpass"
          $pgpassLine = "$pgHost`:$port`:$db`:$user`:$pass"
          Set-Content -Path $pgpassPath -Value $pgpassLine -Encoding ASCII
          if ($IsLinux -or $IsMacOS) { & chmod 600 $pgpassPath | Out-Null }

          $env:PGPASSFILE = $pgpassPath
          $env:PGHOST     = $pgHost
          $env:PGPORT     = "$port"
          $env:PGDATABASE = $db
          $env:PGUSER     = $user

          # Keep connection string single-line (YAML-safe)
          $conn = "host=$pgHost port=$port dbname=$db user=$user sslmode=require"
          if ($ipv4) {
            $conn = "host=$pgHost hostaddr=$ipv4 port=$port dbname=$db user=$user sslmode=require"
          }

          # --- Run psql (capture stderr) ---
          $tmpErr = Join-Path $env:RUNNER_TEMP "rgpt_db_guard_psql_err.txt"
          if (Test-Path $tmpErr) { Remove-Item $tmpErr -Force -ErrorAction SilentlyContinue }

          $outRows = psql "$conn" -v ON_ERROR_STOP=1 -f $sqlFile -P pager=off -A -t 2> $tmpErr
          $code = $LASTEXITCODE

          # --- If password auth failed AND SUPABASE_DB_PASSWORD exists, retry once using that password ---
          if ($code -ne 0) {
            $errText = ""
            if (Test-Path $tmpErr) { $errText = (Get-Content $tmpErr -Raw) }

            $authFail = ($errText -match "password authentication failed")
            $hasAltPw = -not [string]::IsNullOrWhiteSpace($env:SUPABASE_DB_PASSWORD)
            if ($authFail -and $hasAltPw -and $passSource -eq "url") {
              Write-Host "[WARN] psql auth failed using password from URL; retrying with SUPABASE_DB_PASSWORD secret..." -ForegroundColor Yellow

              # Rewrite pgpass using alternate password
              $altPw = $env:SUPABASE_DB_PASSWORD
              $pgpassLine2 = "$pgHost`:$port`:$db`:$user`:$altPw"
              Set-Content -Path $pgpassPath -Value $pgpassLine2 -Encoding ASCII

              if (Test-Path $tmpErr) { Remove-Item $tmpErr -Force -ErrorAction SilentlyContinue }
              $outRows = psql "$conn" -v ON_ERROR_STOP=1 -f $sqlFile -P pager=off -A -t 2> $tmpErr
              $code = $LASTEXITCODE
            }
          }

          if ($code -ne 0) { throw "psql failed with exit code $code" }

          if ($outRows -and $outRows.Trim().Length -gt 0) {
            Write-Host "[FAIL] Exposure regression detected:" -ForegroundColor Red
            $outRows | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            exit 1
          }

          Write-Host "[OK] No unsafe grants detected." -ForegroundColor Green
      - name: Publish status context (rgpt-db-exposure-guard)
        if: always()
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          Set-StrictMode -Version Latest

          # job.status is: success | failure | cancelled
          $jobStatus = "${{ job.status }}"

          switch ($jobStatus) {
            "success"   { $state = "success"; $desc = "DB exposure guard passed" }
            "failure"   { $state = "failure"; $desc = "DB exposure guard failed" }
            default     { $state = "error";   $desc = "DB exposure guard cancelled/unknown" }
          }

          $repo  = "${{ github.repository }}"
          $sha   = "${{ github.sha }}"
          $runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          $body = @{
            state       = $state
            context     = "rgpt-db-exposure-guard"
            description = $desc
            target_url  = $runUrl
          } | ConvertTo-Json -Compress

          $api = "https://api.github.com/repos/$repo/statuses/$sha"

          Invoke-RestMethod -Method Post -Uri $api -Headers @{
            Authorization = "Bearer $env:GH_TOKEN"
            "User-Agent"  = "rgpt-db-exposure-guard"
            Accept        = "application/vnd.github+json"
          } -Body $body | Out-Null

          Write-Host "[OK] Published status context rgpt-db-exposure-guard => $state" -ForegroundColor Green







