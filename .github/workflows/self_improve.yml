name: Self Improve

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why this run
        required: false
  schedule:
    - cron: "*/15 * * * *"

jobs:
  plan-and-nudge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find stalled issues (label=codegen:ready, no open PR)
        id: stalled
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const resIssues = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open label:codegen:ready`,
              per_page: 10
            });
            const candidates = [];
            for (const it of resIssues.data.items) {
              const q = `repo:${owner}/${repo} is:pr is:open ${it.number}`;
              const resPr = await github.rest.search.issuesAndPullRequests({ q, per_page: 5 });
              const hasOpenPr = resPr.data.items?.some(x => x.state === 'open');
              if (!hasOpenPr) candidates.push(it.number);
            }
            core.setOutput('issue_list', JSON.stringify(candidates));

      - name: Nudge AI Codegen for stalled issues
        if: ${{ steps.stalled.outputs.issue_list != '' && steps.stalled.outputs.issue_list != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issues = JSON.parse(`${{ steps.stalled.outputs.issue_list }}`);
            for (const iss of issues) {
              core.info(`Dispatching AI Codegen for #${iss}`);
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "codegen.yml",
                ref: "main",
                inputs: { issue_number: String(iss) }
              }).catch(e => core.warning(e.message));
              // Nudge label to re-trigger label-based automations
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(iss),
                labels: ["codegen:ready"]
              }).catch(e => core.warning(e.message));
            }