name: Self Improve (v4 Core AI)

# RocketGPT v4 Core AI – Self-Improvement Loop
# Foundation docs:
# - docs/self-improvement-charter.md
# - docs/real-self-improving-rocketgpt.md
# - docs/roadmap/v4-core-ai.md
#
# Philosophy (Nirav’s Definition):
# 1) There must be a clear goal. The system takes actions, checks results vs that goal,
#    keeps what helps and corrects what does not. This is an ongoing loop.
# 2) When behavior is wrong, misaligned, or causes problems for others, the system must
#    self-correct so that the same harm/friction does not repeat.
#
# This workflow is a LOW-RISK self-improvement driver:
# - Goal: avoid “stalled” AI codegen issues that never move forward.
# - Actions: periodically scan for open issues with label `codegen:ready` and no open PR.
# - Result check: if such issues exist, nudge `codegen.yml` to act on them.
# - No direct code changes; only triggers other guarded workflows.

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why this run (manual self-improvement session)
        required: false
  schedule:
    # v4 note: still frequent, but logic is minimal and safe. Can be tuned later.
    - cron: "*/15 * * * *"

jobs:
  plan-and-nudge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find stalled issues (label=codegen:ready, no open PR)
        id: stalled
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const resIssues = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open label:codegen:ready`,
              per_page: 10
            });

            const candidates = [];
            for (const it of resIssues.data.items) {
              // Check if there is any open PR referencing this issue number
              const q = `repo:${owner}/${repo} is:pr is:open ${it.number}`;
              const resPr = await github.rest.search.issuesAndPullRequests({ q, per_page: 5 });
              const hasOpenPr = resPr.data.items?.some(x => x.state === "open");
              if (!hasOpenPr) candidates.push(it.number);
            }

            core.info(`Stalled issues (no open PR): ${JSON.stringify(candidates)}`);
            core.setOutput("issue_list", JSON.stringify(candidates));

      - name: Nudge AI Codegen for stalled issues
        if: ${{ steps.stalled.outputs.issue_list != '' && steps.stalled.outputs.issue_list != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            // v4 alignment:
            // - Goal: Unblock stalled, ready-for-codegen issues.
            // - No direct merge or workflow edits; only safe workflow dispatches and labels.
            const issues = JSON.parse(`${{ steps.stalled.outputs.issue_list }}`);
            for (const iss of issues) {
              core.info(`Dispatching AI Codegen for #${iss}`);
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "codegen.yml",
                ref: "main",
                inputs: { issue_number: String(iss) }
              }).catch(e => core.warning(e.message));

              // Nudge label to re-trigger label-based automations, if any.
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(iss),
                labels: ["codegen:ready"]
              }).catch(e => core.warning(e.message));
            }
