name: Policy Gate/check-policy

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  policy_gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Policy Checks (pwsh)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $files = Get-ChildItem -Path ".github/workflows" -Filter "*.yml" -Recurse
          if (-not $files) {
            Write-Host "::warning file=.github/workflows::No workflows found"
            exit 0
          }

          $fail = $false

          foreach ($f in $files) {
            $content = Get-Content $f.FullName -Raw

            # 1) Workflow must have "name:"
            if ($content -notmatch "(?m)^\s*name:\s*.+") {
              Write-Host "::error file=$($f.FullName),line=1::Missing 'name:' at top-level"
              $fail = $true
            }

            # 2) Strongly recommend workflow_dispatch present for manual runs
            if ($content -notmatch "(?ms)^\s*on:\s*(?:\n|\r\n).*workflow_dispatch:") {
              Write-Host "::warning file=$($f.FullName),line=1::Add 'on: workflow_dispatch:' to enable manual runs"
            }

            # 3) For security: deny unpinned external actions (must have @vX)
            $badRefs = Select-String -InputObject $content -Pattern "uses:\s+[^\s@]+(?!@)"
            if ($badRefs) {
              Write-Host "::error file=$($f.FullName)::Pin external actions with a version tag (e.g., actions/checkout@v4)"
              $fail = $true
            }
          }

          if ($fail) { exit 1 }
