name: policy_gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  statuses: write

concurrency:
  group: policy_gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  policy_gate:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft != true }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine changed files
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: |
            .github/workflows/**
            .github/**.yml
            .github/**.yaml
            .github/**.json
            docs/ops/**
            docs/security/**
            rocketgpt-agents/**
            rocketgpt-web/**
            supabase/**

      - name: Policy gate summary
        shell: bash
        run: |
          set -euo pipefail
          echo "Changed files:"
          echo "${{ steps.diff.outputs.all_changed_files }}"

      # --- HARD RULE: Block workflow edits unless allowlisted (allow self only) ---
      - name: Block workflow edits unless allowlisted
        shell: bash
        run: |
          set -euo pipefail
          CHANGED="${{ steps.diff.outputs.all_changed_files }}"
          # changed-files returns a space-separated list; normalize to one-per-line
          WF=$(printf "%s\n" "$CHANGED" | tr ' ' '\n' | grep -E '^\.github/workflows/' || true)

          if [ -z "$WF" ]; then
            echo "No workflow file changes detected."
            exit 0
          fi

          echo "Workflow file changes detected:"
          echo "$WF"

          # Allow policy_gate.yml to modify itself; block any other workflow edits
          BLOCK=$(printf "%s\n" "$WF" | grep -vE '^\.github/workflows/policy_gate\.yml$' || true)

          if [ -n "$BLOCK" ]; then
            echo "::error::Blocked workflow edits (not allowlisted):"
            echo "$BLOCK"
            exit 1
          fi

          echo "Only policy_gate.yml changed (allowed)."

      - name: Publish status context (policy_gate)
        if: always()
        uses: actions/github-script@v7
        env:
          JOB_STATUS: ${{ job.status }}
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const st  = (process.env.JOB_STATUS || "").toLowerCase();
            const state = (st === "success") ? "success" : "failure";
            const desc  = "policy_gate => " + (st || "unknown");
            const url   = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Retry on transient GitHub errors
            async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
            const max = 5;
            for (let i=1; i<=max; i++){
              try{
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha,
                  state,
                  context: "policy_gate",
                  description: desc,
                  target_url: url
                });
                core.info(`Published policy_gate status (${state}) on ${sha}`);
                break;
              } catch (e) {
                core.warning(`Attempt ${i}/${max} failed: ${e.status || ''} ${e.message}`);
                if (i === max) throw e;
                await sleep(1500 * i);
              }
            }
