name: policy_gate

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: policy_gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependabot_policy_gate:
    name: Dependabot Policy Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RGPT_AUTOMATION_PAT || github.token }}

      - name: Validate route-auth surface matrix
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path 'docs/security/generated/RUNTIME_ALLOWLIST.json')) {
            throw 'Missing docs/security/generated/RUNTIME_ALLOWLIST.json (ensure allowlist generation step runs before validation).'
          }
          if (-not (Test-Path 'docs/security/AUTH_SURFACE_MATRIX.md')) {
            throw 'Missing docs/security/AUTH_SURFACE_MATRIX.md'
          }
          pwsh -NoProfile -File .github/tools/policy_gate/validate_auth_surface_matrix.ps1 -AllowlistJson docs/security/generated/RUNTIME_ALLOWLIST.json -MatrixMd docs/security/AUTH_SURFACE_MATRIX.md

      - name: Security - API Surface Drift Check
        shell: pwsh
        run: ./.github/tools/security/check_api_surface_drift.ps1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Dependabot policy gate (path-scoped)
        shell: pwsh
        run: |
          pwsh -NoProfile -File scripts/security/policy_gate_dependabot.ps1

  l0_ownership_guard:
    name: L0 Ownership Guard (immutable files)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.RGPT_AUTOMATION_PAT || github.token }}
          fetch-depth: 0

      - name: Detect changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          # Determine diff range
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            base="${GITHUB_BASE_REF}"
            git fetch --no-tags --prune origin "${base}" --depth=200 || true
            range="origin/${base}...HEAD"
          else
            before="${GITHUB_EVENT_BEFORE:-}"
            sha="${GITHUB_SHA}"
            if [ -n "${before}" ] && [ "${before}" != "0000000000000000000000000000000000000000" ]; then
              range="${before}...${sha}"
            else
              # fallback for initial commits
              if git rev-parse --verify -q HEAD~1 >/dev/null; then
                range="HEAD~1...HEAD"
              else
                range="HEAD...HEAD"
              fi
            fi
          fi

          echo "range=${range}" >> $GITHUB_OUTPUT
          echo "[L0] Range: ${range}"
          git diff --name-only "${range}" | sed '/^\s*$/d' > changed_files.txt || true
          echo "[L0] Changed files:"
          cat changed_files.txt || true

      - name: Enforce L0 immutability
        shell: bash
        run: |
          set -euo pipefail
          blocked=0

          if [ ! -s changed_files.txt ]; then
            echo "[L0] No changed files. OK."
            exit 0
          fi

          while IFS= read -r f; do
            [ -z "$f" ] && continue
            case "$f" in
              .github/workflows/policy_gate.yml)
                echo "::error::Blocked change (L0): $f"; blocked=1 ;;
              docs/ops/ledger/*)
                echo "::error::Blocked change (L0): $f"; blocked=1 ;;
              docs/ops/policy/POLICY_OWNERSHIP_MATRIX.md)
                echo "::error::Blocked change (L0): $f"; blocked=1 ;;
              *)
                ;;
            esac
          done < changed_files.txt

          if [ "$blocked" -ne 0 ]; then
            echo "::error::L0 ownership violation: immutable artifacts modified."
            exit 1
          fi

          echo "[L0] OK - no immutable artifacts were modified."


  pr_label_enforcement:
    name: PR Label Enforcement (workflow-edit / auto-merge)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.RGPT_AUTOMATION_PAT || github.token }}
          fetch-depth: 0

      - name: Get PR labels
        id: labels
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.RGPT_AUTOMATION_PAT || github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/labels"
          labels="$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "${api}" | jq -r '.[].name' | tr '\n' ' ')"
          echo "labels=${labels}" >> $GITHUB_OUTPUT
          echo "[LABELS] ${labels}"

      - name: Detect changed files in PR
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.base_ref }}"
          git fetch --no-tags --prune origin "${base}" --depth=200 || true
          range="origin/${base}...HEAD"
          echo "[DIFF] range=${range}"
          git diff --name-only "${range}" | sed '/^\s*$/d' > changed_files.txt || true
          echo "[DIFF] changed files:"
          cat changed_files.txt || true

      - name: Enforce labels
        shell: bash
        env:
          LABELS: ${{ steps.labels.outputs.labels }}
        run: |
          set -euo pipefail

          need_workflow_edit=0
          need_auto_merge=0

          # Rules:
          # - If any workflow file changes -> require safe:workflow-edit
          # - If auto-update workflow or auto-ops allowlist changes -> require safe:auto-merge
          if [ -s changed_files.txt ]; then
            while IFS= read -r f; do
              case "$f" in
                .github/workflows/*)
                  need_workflow_edit=1 ;;
              esac

              case "$f" in
                .github/workflows/auto_update_policy.yml|.github/auto-ops.yml)
                  need_auto_merge=1 ;;
              esac
            done < changed_files.txt
          fi

          echo "[REQ] workflow-edit=${need_workflow_edit} auto-merge=${need_auto_merge}"
          echo "[HAVE] ${LABELS}"

          if [ "${need_workflow_edit}" -eq 1 ]; then
            echo "${LABELS}" | grep -q "safe:workflow-edit" || {
              echo "::error::Missing required label: safe:workflow-edit"
              exit 1
            }
          fi

          if [ "${need_auto_merge}" -eq 1 ]; then
            echo "${LABELS}" | grep -q "safe:auto-merge" || {
              echo "::error::Missing required label: safe:auto-merge"
              exit 1
            }
          fi

          echo "[OK] PR label enforcement passed."
