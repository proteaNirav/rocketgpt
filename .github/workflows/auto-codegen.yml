name: Auto Codegen (issue -> PR)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  codegen:
    if: contains(github.event.issue.labels.*.name, 'codegen:ready')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
@v4
        with:
          fetch-depth: 0

      - name: Prep tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq moreutils
          git config user.name "rocketgpt-bot"
          git config user.email "bot@rocketgpt.local"

      - name: Build prompt from issue
        id: prompt
        run: |
          mkdir -p .rocket/codegen
          cat > .rocket/codegen/prompt.txt <<'PROMPT'
You are RocketGPT's senior full-stack engineer.
Generate a minimal, production-quality patch for this repository **as a unified git diff**.

REQUIREMENTS:
- Output ONLY a valid unified diff starting with "diff --git".
- Keep changes focused; add tests if trivial.
- If Next.js/TS: respect existing tsconfig, eslint, scripts.
- Include new files correctly in the diff (with /dev/null in the from-file).
- No secrets, no .env commits.
- Keep to free-tier compatible approaches.

REPO CONTEXT (abridged):
- Stack: Next.js (app router), Supabase Auth, Vercel, GitHub Actions CI.
- Branch policy: PR into `develop`, squash merge.
- Codeowners require review.

USER STORY (from GitHub issue body):
PROMPT
          printf '\n--- ISSUE BODY START ---\n\n' >> .rocket/codegen/prompt.txt
          jq -r '.issue.body' <(echo '${{ toJson(github.event) }}') >> .rocket/codegen/prompt.txt
          printf '\n--- ISSUE BODY END ---\n' >> .rocket/codegen/prompt.txt

      - name: Call Claude to produce a patch
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          body=$(jq -Rs --arg model "claude-3-5-sonnet-latest" '{model:$model, max_tokens:2500, messages:[{role:"user", content:.}]}' .rocket/codegen/prompt.txt)
          curl -sS https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$body" | tee .rocket/codegen/claude.json | \
          jq -r 'try .content[0].text catch ""' > .rocket/codegen/patch.txt

          # Extract only the diff (in case the model adds prose)
          awk '/^diff --git/{flag=1} flag{print}' .rocket/codegen/patch.txt > .rocket/codegen/patch.diff || true
          if [ ! -s .rocket/codegen/patch.diff ]; then
            echo "No diff produced"; exit 1
          fi
          head -n 60 .rocket/codegen/patch.diff

      - name: Apply patch
        run: |
          set -e
          git checkout -b "ai/autocode/${{ github.event.issue.number }}"
          git apply --index --reject .rocket/codegen/patch.diff || true

          # If rejects exist, stop and attach artifacts
          rejects=$(git status --porcelain | wc -l)
          if [ "$rejects" -eq "0" ]; then
            echo "Patch applied cleanly."
          else
            echo "Patch had conflicts; uploading artifacts and exiting."
            exit 2
          fi

      - name: Commit & push
        if: ${{ success() }}
        run: |
          msg="feat: autocode for issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          git add -A
          git commit -m "$msg"
          git push -u origin "ai/autocode/${{ github.event.issue.number }}"

      - name: Open PR to develop
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = `feat: autocode for #${{ github.event.issue.number }} - ${{ github.event.issue.title }}`;
            const body = [
              "Auto-generated by **Auto Codegen**.",
              "",
              "**Source issue:** #${{ github.event.issue.number }}",
              "",
              "Please review with care. No secrets, small diff policy.",
            ].join("\n");
            const res = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `ai/autocode/${{ github.event.issue.number }}`,
              base: "develop",
              title,
              body
            });
            core.notice(`PR #${res.data.number} opened`);

      - name: Upload artifacts (patch)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
@v4
        with:
          name: autocode-artifacts
          path: .rocket/codegen/
          if-no-files-found: warn

