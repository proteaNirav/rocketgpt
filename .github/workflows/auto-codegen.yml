name: Auto Codegen (issue -> PR)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  codegen:
    # Only run when label 'codegen:ready' is present
    if: contains(join(github.event.issue.labels.*.name, ','), 'codegen:ready')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prep tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq moreutils
          git config user.name "rocketgpt-bot"
          git config user.email "bot@rocketgpt.local"

      - name: Build prompt from issue
        id: prompt
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          mkdir -p .rocket/codegen
          cat > .rocket/codegen/prompt.txt << 'PROMPT'
You are RocketGPT's senior full-stack engineer.
Generate a minimal, production-quality patch for this repository **as a unified git diff**.

REQUIREMENTS:
- Output ONLY a valid unified diff starting with "diff --git".
- Keep changes focused; add tests if trivial.
- If Next.js/TS: respect existing tsconfig, eslint, scripts.
- Include new files correctly in the diff (with /dev/null in the from-file).
- No secrets, no .env commits.
- Keep to free-tier compatible approaches.

REPO CONTEXT (abridged):
- Stack: Next.js (app router), Supabase Auth, Vercel, GitHub Actions CI.
- Branch policy: PR into `develop`, squash merge.
- Codeowners require review.

PROMPT
PROMPT
          printf '\n--- ISSUE BODY START ---\n\n' >> .rocket/codegen/prompt.txt
          printf '%s\n' "$ISSUE_BODY" >> .rocket/codegen/prompt.txt
          printf '\n--- ISSUE BODY END ---\n' >> .rocket/codegen/prompt.txt

      - name: Call Claude to produce a patch
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          set -e
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "CLAUDE_API_KEY secret is not set"; exit 1;
          fi

          body=$(jq -Rs --arg model "claude-3-5-sonnet-latest" '{model:$model, max_tokens:2500, messages:[{role:"user", content:.}]}' .rocket/codegen/prompt.txt)

          curl -sS https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$body" | tee .rocket/codegen/claude.json | \
          jq -r 'try .content[0].text catch ""' > .rocket/codegen/patch.txt

          # Extract only the diff (in case the model adds prose)
          awk '/^diff --git/{flag=1} flag{print}' .rocket/codegen/patch.txt > .rocket/codegen/patch.diff || true
          if [ ! -s .rocket/codegen/patch.diff ]; then
            echo "No diff produced"; exit 1
          fi
          echo "=== Preview of generated diff ==="
          head -n 60 .rocket/codegen/patch.diff || true

      - name: Apply patch
        run: |
          set -e
          git checkout -b "ai/autocode/${{ github.event.issue.number }}"
          git apply --index --reject .rocket/codegen/patch.diff || true

          rejects=$(git status --porcelain | wc -l)
          if [ "$rejects" -eq "0" ]; then
            echo "Patch applied cleanly."
          else
            echo "Patch had conflicts; exiting with non-zero so humans can inspect artifacts."
            exit 2
          fi

      - name: Commit & push
        if: ${{ success() }}
        run: |
          msg="feat: autocode for issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          git add -A
          git commit -m "$msg"
          git push -u origin "ai/autocode/${{ github.event.issue.number }}"

      - name: Open PR to develop
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.issue.number }};
            const issueTitle = `${{ toJson(github.event.issue.title) }}`;
            const headBranch = `ai/autocode/${issueNumber}`;
            const title = `feat: autocode for #${issueNumber} - ${issueTitle}`;
            const body = [
              "Auto-generated by **Auto Codegen**.",
              "",
              `**Source issue:** #${issueNumber}`,
              "",
              "Please review with care. No secrets, small diff policy."
            ].join("\n");

            const res = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: headBranch,
              base: "develop",
              title,
              body,
            });
            core.notice(`PR #${res.data.number} opened`);

      - name: Upload artifacts (patch)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: autocode-artifacts
          path: .rocket/codegen/
          if-no-files-found: warn
