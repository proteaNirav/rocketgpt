name: AI Codegen

on:
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  triage:
    if: >
      ${{
        (github.event_name == 'workflow_dispatch') ||
        (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'codegen:ready'))
      }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Resolve issue number
        id: iss
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "num=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "num=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Sanity log
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Issue #: ${{ steps.iss.outputs.num }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"

      - name: Prep tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq moreutils
          git config user.name "rocketgpt-bot"
          git config user.email "bot@rocketgpt.local"

      - name: Build prompt from issue
        id: prompt
        run: |
          mkdir -p .rocket/codegen
          cat > .rocket/codegen/prompt.txt <<'PROMPT'
You are RocketGPT's senior full-stack engineer.
Generate a minimal, production-quality patch for this repository **as a unified git diff**.

REQUIREMENTS:
- Output ONLY a valid unified diff starting with "diff --git".
- Keep changes focused; add tests if trivial.
- Respect Next.js + TypeScript conventions.
- Include new files using /dev/null in the from-file.
- No secrets or .env changes. Free-tier only.

USER STORY (from GitHub issue body):
PROMPT
          num="${{ steps.iss.outputs.num }}"
          echo -e "\n--- ISSUE BODY START ---\n" >> .rocket/codegen/prompt.txt
          gh api repos/${{ github.repository }}/issues/$num --jq .body >> .rocket/codegen/prompt.txt
          echo -e "\n--- ISSUE BODY END ---" >> .rocket/codegen/prompt.txt

      - name: Call Claude to produce a patch
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          set -e
          body=$(jq -Rs --arg model "claude-3-5-sonnet-latest" '{model:$model, max_tokens:2500, messages:[{role:"user", content:.}]}' .rocket/codegen/prompt.txt)
          curl -sS https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$body" | tee .rocket/codegen/claude.json | jq -r 'try .content[0].text catch ""' > .rocket/codegen/patch.txt
          awk '/^diff --git/{flag=1} flag{print}' .rocket/codegen/patch.txt > .rocket/codegen/patch.diff || true
          test -s .rocket/codegen/patch.diff

      - name: Apply patch
        run: |
          set -e
          num="${{ steps.iss.outputs.num }}"
          git checkout -b "ai/autocode/${num}"
          git apply --index --reject .rocket/codegen/patch.diff || true
          rejCount=$(git status --porcelain | wc -l)
          if [ "$rejCount" -gt 0 ]; then
            echo "Patch had conflicts ($rejCount files). See artifacts."; exit 2
          fi

      - name: Commit & push
        if: ${{ success() }}
        run: |
          num="${{ steps.iss.outputs.num }}"
          title=$(gh api repos/${{ github.repository }}/issues/$num --jq .title)
          git add -A
          git commit -m "feat: autocode for issue #$num - $title"
          git push -u origin "ai/autocode/${num}"

      - name: Open PR to develop
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const num = `#${{ steps.iss.outputs.num }}`;
            const issue = await github.rest.issues.get({ owner: context.repo.owner, repo: context.repo.repo, issue_number: parseInt(${{ steps.iss.outputs.num }}) });
            const title = `feat: autocode for ${num} - ${issue.data.title}`;
            const body = [
              "Auto-generated by **AI Codegen**.",
              "",
              `**Source issue:** ${num}`,
              "",
              "Please review with care. No secrets, small diff policy.",
            ].join("\n");
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `ai/autocode/${{ steps.iss.outputs.num }}`,
              base: "develop",
              title,
              body
            });
            core.notice(`PR #${pr.data.number} opened`);

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ai-autocode-artifacts
          path: .rocket/codegen/
          if-no-files-found: warn
