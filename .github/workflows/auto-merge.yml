name: Auto Merge (AI-approved)

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

concurrency:
  group: auto-merge-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  merge:
    if: |
      !github.event.pull_request.draft &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'auto-merge:ready') &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Ensure all checks are green
        id: checks
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const sha = context.payload.pull_request.head.sha;

            // Combined status (legacy) â€“ simple and effective for our use
            const { data } = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: sha });
            core.info(`Combined status: ${data.state}`);
            core.setOutput('ok', data.state === 'success');

      - name: Merge PR (squash)
        if: steps.checks.outputs.ok == 'true'
        uses: peter-evans/merge-pull-request@v2
        with:
          commit-message: pull-request-title
          merge-method: squash
