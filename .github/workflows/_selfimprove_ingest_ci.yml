name: _selfimprove_ingest_ci

on:
  workflow_dispatch:
    inputs:
      subsystem:
        description: "Subsystem name for ledger row"
        required: false
        default: "ci-selfimprove"
      severity:
        description: "Severity (info|warning|error|critical)"
        required: false
        default: "error"
      title_prefix:
        description: "Title prefix"
        required: false
        default: "CI"
      confidence:
        description: "Confidence 0..1"
        required: false
        default: "0.80"

  workflow_call:
    inputs:
      subsystem:
        required: false
        type: string
        default: "ci-selfimprove"
      severity:
        required: false
        type: string
        default: "error"
      title_prefix:
        required: false
        type: string
        default: "CI"
      confidence:
        required: false
        type: string
        default: "0.80"

jobs:
  ingest:
    runs-on: ubuntu-latest
    env:
      RGPT_SUBSYSTEM_FALLBACK: ci-selfimprove
      RGPT_SEVERITY_FALLBACK: error
      RGPT_TITLE_PREFIX_FALLBACK: CI
      RGPT_CONFIDENCE_FALLBACK: "0.80"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ingest CI failure into Self-Improve Ledger (aligned RPC)
        shell: pwsh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          $subsystem = ("${{ inputs.subsystem }}".Trim()); if ([string]::IsNullOrWhiteSpace($subsystem)) { $subsystem = $env:RGPT_SUBSYSTEM_FALLBACK }
          $severity  = ("${{ inputs.severity }}".Trim());  if ([string]::IsNullOrWhiteSpace($severity))  { $severity  = $env:RGPT_SEVERITY_FALLBACK }
          $prefix    = ("${{ inputs.title_prefix }}".Trim()); if ([string]::IsNullOrWhiteSpace($prefix)) { $prefix = $env:RGPT_TITLE_PREFIX_FALLBACK }
          $confRaw = ("${{ inputs.confidence }}".Trim()); if ([string]::IsNullOrWhiteSpace($confRaw)) { $confRaw = $env:RGPT_CONFIDENCE_FALLBACK }; $conf = [double]$confRaw

          $runUrl = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          $origin = "gh:${{ github.repository }}:${{ github.workflow }}:${{ github.run_id }}:${{ github.job }}"

          $title = "$prefix :: ${{ github.workflow }} :: job ${{ github.job }}"
          $desc  = "Workflow: ${{ github.workflow }}
Job: ${{ github.job }}
Repo: ${{ github.repository }}
Ref: ${{ github.ref_name }}
SHA: ${{ github.sha }}
Run URL: $runUrl
Origin: $origin"

          ./.github/tools/rgpt-ledger-ingest.ps1 
            -SUPABASE_URL $env:SUPABASE_URL 
            -SUPABASE_SERVICE_ROLE_KEY $env:SUPABASE_SERVICE_ROLE_KEY 
            -Subsystem $subsystem 
            -Severity $severity 
            -Title $title 
            -Description $desc 
            -Confidence $conf 
            -EvidenceRef $runUrl 
            -RelatedCommit "${{ github.sha }}" 
            -RelatedPR "" 
            -OriginRef $origin
