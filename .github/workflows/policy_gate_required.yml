name: policy_gate

on:
  pull_request:
  workflow_dispatch:

permissions:
  checks: read
  contents: read

jobs:
  policy_gate:
    name: policy_gate
    runs-on: ubuntu-latest
    steps:
      - name: Wait for policy gate sub-jobs to complete and succeed
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA:  ${{ github.sha }}
        run: |
          $ErrorActionPreference = "Stop"

          $must = @(

    - name: Publish policy_gate status context
      if: ${{ always() }}
      shell: pwsh
      run: |
        $state = if ("${{ job.status }}" -eq "success") { "success" } else { "failure" }
        $body = @{
          state       = $state
          context     = "policy_gate"
          description = "policy_gate_required => $state"
          target_url  = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        } | ConvertTo-Json
        $headers = @{
          Authorization = "Bearer ${{ github.token }}"
          Accept        = "application/vnd.github+json"
          "X-GitHub-Api-Version" = "2022-11-28"
        }
        $url = "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}"
        Invoke-RestMethod -Method Post -Uri $url -Headers $headers -Body $body | Out-Null
        Write-Host "Published commit status context policy_gate => $state"
  "policy_gate/Dependabot Policy Gate",
  "policy_gate/L0 Ownership Guard (immutable files)",
  "policy_gate/PR Label Enforcement (workflow-edit / auto-merge)"
)",
            "PR Label Enforcement (workflow-edit / auto-merge)"
          )

          function Get-CheckRuns {
            $json = gh api "repos/$env:REPO/commits/$env:SHA/check-runs?per_page=100"
            return ($json | ConvertFrom-Json).check_runs
          }

          $maxTries = 30
          $sleepSec = 10

          for ($try=1; $try -le $maxTries; $try++) {
            $runs = Get-CheckRuns

            $hits = foreach ($n in $must) {
              $r = $runs | Where-Object { $_.name -eq $n } | Select-Object -First 1
              [pscustomobject]@{
                name       = $n
                status     = $r.status
                conclusion = $r.conclusion
                details    = $r.html_url
                found      = [bool]$r
              }
            }

            Write-Host ""
            Write-Host "Try $try/$maxTries — required sub-checks status:" -ForegroundColor Yellow
            $hits | Format-Table -AutoSize

            $missing = $hits | Where-Object { -not $_.found }
            $pending = $hits | Where-Object { $_.found -and $_.status -ne "completed" }
            $failed  = $hits | Where-Object { $_.found -and $_.status -eq "completed" -and $_.conclusion -ne "success" }

            if ($failed) {
              Write-Error ("policy_gate_required: FAILED because these checks failed: " + (($failed.name) -join ", "))
            }

            if ((-not $missing) -and (-not $pending)) {
              Write-Host "policy_gate_required: OK — all required sub-checks succeeded." -ForegroundColor Green
              exit 0
            }

            Start-Sleep -Seconds $sleepSec
          }

          Write-Error "policy_gate_required: TIMEOUT waiting for sub-checks to complete."

