name: policy_gate_aggregator

on:
  pull_request:
  workflow_dispatch:

permissions:
  checks: read
  contents: read
  statuses: write

jobs:
  aggregator:
    name: Policy Gate Aggregator
    runs-on: ubuntu-latest
    steps:
      - name: Wait for policy gate sub-jobs to complete and succeed
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = "Stop"

          # Required sub-checks from policy_gate.yml workflow
          # These are job display names (the 'name:' field in each job)
          $must = @(
  # These must match GitHub CHECK-RUN names on the PR head SHA
  "prompt_bypass_scan",
  "drift_lock",
  "rgpt-db-exposure-guard",
  "safemode-gate",
  "smoke"
)"
          )

          # PR Label Enforcement only runs on pull_request events
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $must += "PR Label Enforcement (workflow-edit / auto-merge)"
          }

          function Get-PrHeadSha {
            if (-not (Test-Path $env:GITHUB_EVENT_PATH)) {
              throw "GITHUB_EVENT_PATH not found; cannot determine PR."
            }
            $evt = Get-Content -LiteralPath $env:GITHUB_EVENT_PATH -Raw | ConvertFrom-Json
            $prNumber = $evt.pull_request.number
            if (-not $prNumber) {
              throw "Could not determine PR number from event payload."
            }
            $pr = gh api "repos/$env:REPO/pulls/$prNumber" --jq '.head.sha' 2>$null
            if (-not $pr) {
              throw "Could not determine PR head SHA."
            }
            return $pr.Trim()
          }

          function Get-CheckRuns {
            param([string]$sha)
            $json = gh api "repos/$env:REPO/commits/$sha/check-runs?per_page=100" 2>$null
            if (-not $json) { return @() }
            $parsed = $json | ConvertFrom-Json
            return @($parsed.check_runs)
          }

          $headSha = Get-PrHeadSha
          Write-Host "PR head SHA: $headSha"

          $maxTries = 30
          $sleepSec = 10

          for ($try = 1; $try -le $maxTries; $try++) {
            $runs = Get-CheckRuns -sha $headSha

            $hits = foreach ($n in $must) {
              $r = $runs | Where-Object { $_.name -eq $n } | Select-Object -First 1
              [pscustomobject]@{
                name       = $n
                status     = $r.status
                conclusion = $r.conclusion
                details    = $r.html_url
                found      = [bool]$r
              }
            }

            Write-Host ""
            Write-Host "Try $try/$maxTries - required sub-checks status:" -ForegroundColor Yellow
            $hits | Format-Table -AutoSize

            $missing = @($hits | Where-Object { -not $_.found })
            $pending = @($hits | Where-Object { $_.found -and $_.status -ne "completed" })
            $failed  = @($hits | Where-Object { $_.found -and $_.status -eq "completed" -and $_.conclusion -ne "success" })

            if ($failed.Count -gt 0) {
              Write-Host "FAILED sub-checks: $($failed.name -join ', ')" -ForegroundColor Red
              # Publish failure status context for branch protection
              $body = @{ state = "failure"; context = "policy_gate"; description = "Sub-check failed: $($failed.name -join ', ')" } | ConvertTo-Json -Compress
              echo $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input - 2>$null
              throw "policy_gate: FAILED - sub-checks failed: $($failed.name -join ', ')"
            }

            if ($missing.Count -eq 0 -and $pending.Count -eq 0) {
              Write-Host "policy_gate: OK - all required sub-checks succeeded." -ForegroundColor Green
              # Publish success status context for branch protection
              $body = @{ state = "success"; context = "policy_gate"; description = "All policy gate sub-checks passed" } | ConvertTo-Json -Compress
              echo $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input - 2>$null
              exit 0
            }

            Write-Host "Waiting... missing=$($missing.Count) pending=$($pending.Count)"
            Start-Sleep -Seconds $sleepSec
          }

          # Timeout - publish failure status context
          $body = @{ state = "failure"; context = "policy_gate"; description = "Timeout waiting for sub-checks" } | ConvertTo-Json -Compress
          echo $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input - 2>$null
          throw "policy_gate: TIMEOUT waiting for sub-checks to complete."

