name: policy_gate_aggregator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}

permissions:
  checks: read
  contents: read
  pull-requests: read
  statuses: write

jobs:
  aggregator:
    name: Policy Gate Aggregator
    runs-on: ubuntu-latest
    steps:
      - name: Wait for policy gate sub-jobs to complete and succeed
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = "Stop"

          # Required sub-checks (check-run names)
          $must = @(
            "prompt_bypass_scan",
            "drift_lock",
            "rgpt-db-exposure-guard",
            "safemode-gate",
            "smoke",
            "build-test"
          )

          function Get-PrHeadSha {
            if (-not (Test-Path $env:GITHUB_EVENT_PATH)) {
              throw "GITHUB_EVENT_PATH not found; cannot determine PR."
            }
            $evt = Get-Content -LiteralPath $env:GITHUB_EVENT_PATH -Raw | ConvertFrom-Json
            $sha = $evt.pull_request.head.sha
            if (-not $sha) { throw "Could not determine PR head SHA from event payload." }
            return $sha.Trim()
          }

          function Get-CheckRuns {
            param([string]$sha)
            $json = gh api "repos/$env:REPO/commits/$sha/check-runs?per_page=100" -H "Accept: application/vnd.github+json"
            $parsed = $json | ConvertFrom-Json
            return @($parsed.check_runs)
          }

          $headSha = Get-PrHeadSha
          Write-Host "PR head SHA: $headSha"

          $maxTries = 30
          $sleepSec = 10

          for ($try = 1; $try -le $maxTries; $try++) {
            $runs = Get-CheckRuns -sha $headSha

            $hits = foreach ($n in $must) {
              $r = $runs | Where-Object { $_.name -eq $n } | Select-Object -First 1
              [pscustomobject]@{
                name       = $n
                status     = $r.status
                conclusion = $r.conclusion
                details    = $r.html_url
                found      = [bool]$r
              }
            }

            Write-Host ""
            Write-Host "Try $try/$maxTries - required sub-checks status:" -ForegroundColor Yellow
            $hits | Format-Table -AutoSize

            $missing = @($hits | Where-Object { -not $_.found })
            $pending = @($hits | Where-Object { $_.found -and $_.status -ne "completed" })
            $failed  = @($hits | Where-Object { $_.found -and $_.status -eq "completed" -and $_.conclusion -ne "success" })

            if ($failed.Count -gt 0) {
              Write-Host "FAILED sub-checks: $($failed.name -join ', ')" -ForegroundColor Red
              $body = @{ state = "failure"; context = "policy_gate"; description = "Sub-check failed: $($failed.name -join ', ')" } | ConvertTo-Json -Compress
              $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input -
              throw "policy_gate: FAILED - sub-checks failed: $($failed.name -join ', ')"
            }

            if ($missing.Count -eq 0 -and $pending.Count -eq 0) {
              Write-Host "policy_gate: OK - all required sub-checks succeeded." -ForegroundColor Green
              $body = @{ state = "success"; context = "policy_gate"; description = "All policy gate sub-checks passed" } | ConvertTo-Json -Compress
              $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input -
              exit 0
            }

            Write-Host "Waiting... missing=$($missing.Count) pending=$($pending.Count)"
            Start-Sleep -Seconds $sleepSec
          }

          $body = @{ state = "failure"; context = "policy_gate"; description = "Timeout waiting for sub-checks" } | ConvertTo-Json -Compress
          $body | gh api "repos/$env:REPO/statuses/$headSha" -X POST --input -
          throw "policy_gate: TIMEOUT waiting for sub-checks to complete."
