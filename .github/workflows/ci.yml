name: ci

# Safety: Standard CI pipeline for build, test, lint validation
# - Read-only checkout
# - No write operations to repo or external services
# - BOM detection enforces UTF-8 no-BOM policy

on:
  workflow_dispatch:
  push:
  pull_request:
permissions:
  statuses: write
  contents: read

jobs:
  bom_check:
    name: Detect UTF-8 BOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run BOM detector
        shell: pwsh
        run: |
          pwsh .github/tools/ci/detect-bom.ps1 -Paths @(".github/workflows",".github/tools","docs","rocketgpt_v3_full")
  build-test:
    runs-on: ubuntu-latest
    env:
      CORE_API_BASE: https://rocketgpt-core-api.onrender.com
      NODE_OPTIONS: --max_old_space_size=4096

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Debug: confirm paths/lockfile are where we expect ---
      - name: Show tree (top level + UI folder)
        run: |
          ls -la
          echo '--- UI dir ---'
          ls -la rocketgpt_v3_full/webapp/next || true

      # --- Node 20 setup with pnpm caching (only if lockfile exists) ---
      - name: Setup Node 20 (with pnpm cache if lockfile exists)
        if: ${{ hashFiles('rocketgpt_v3_full/webapp/next/pnpm-lock.yaml') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: rocketgpt_v3_full/webapp/next/pnpm-lock.yaml

      - name: Setup Node 20 (no cache fallback)
        if: ${{ hashFiles('rocketgpt_v3_full/webapp/next/pnpm-lock.yaml') == '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack (for pnpm)
        run: corepack enable


      - name: Activate pnpm (corepack)
        run: corepack prepare pnpm@10.26.1 --activate

      # --- UI: install, typecheck, lint, build ---
      - name: Validate package.json (UI)
        working-directory: rocketgpt_v3_full/webapp/next
        run: node -e "JSON.parse(require('fs').readFileSync('package.json','utf8')); console.log('package.json OK')"

      - name: Install UI deps
        working-directory: rocketgpt_v3_full/webapp/next
        run: pnpm install --frozen-lockfile

      - name: Typecheck (UI)
        working-directory: rocketgpt_v3_full/webapp/next
        run: npx tsc -v && npx tsc --noEmit

      # Auto-fix lintable issues (mostly import/order)
      - name: Lint (UI) - autofix
        working-directory: rocketgpt_v3_full/webapp/next
        run: npx eslint . --ext .ts,.tsx --fix || true

      - name: Lint (UI) - strict
        working-directory: rocketgpt_v3_full/webapp/next
        run: npx eslint . --ext .ts,.tsx --max-warnings=0

      - name: Build (UI)
        working-directory: rocketgpt_v3_full/webapp/next
        run: pnpm build

      # --- Core API quick hygiene (Python) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pipx install ruff

      - name: Lint core-api (non blocking)
        run: ruff check rocketgpt_v3_full/apps/core-api || true

      - name: Format core-api (non blocking)
        run: ruff format rocketgpt_v3_full/apps/core-api || true

      # --- QA smoke: run scenarios against live Core API ---
      - name: Run QA scenarios
        run: node qa/runner.mjs qa/scenarios/*.json | tee qa-report.json

      - name: Upload QA report
        uses: actions/upload-artifact@v4
        with:
          name: qa-report
          path: qa-report.json
      - name: Publish status context (build-test)
        if: always()
        uses: actions/github-script@v7
        env:
          JOB_STATUS: ${{ job.status }}
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const st  = (process.env.JOB_STATUS || "").toLowerCase();
            const state = (st === "success") ? "success" : "failure";
            const desc  = "ci build-test => " + (st || "unknown");
            const url   = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state,
              context: "build-test",
              description: desc,
              target_url: url
            });

