name: Triage Spec

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: triage-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

env:
  # Gate: require label 'self-apply' to proceed (set repo variable to 'false' to disable)
  TRIAGE_REQUIRE_LABEL: ${{ vars.TRIAGE_REQUIRE_LABEL || 'true' }}

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ 1) Parse JSON spec from the issue body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Parse Business Spec from Issue Body
        id: spec
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const m = body.match(/```json([\s\S]*?)```/i);
            const json = m ? m[1].trim() : '{}';
            core.setOutput('spec', json);

      - name: Save spec.json
        run: |
          echo '${{ steps.spec.outputs.spec }}' > spec.json
          echo "Wrote spec.json ($(wc -c < spec.json) bytes)"

      # â”€â”€ 2) Log event payload & keep artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Log event payload (triage)
        run: |
          echo "::group::Event JSON"
          echo '${{ toJson(github.event) }}' > event.json
          jq -C '.' event.json || cat event.json
          echo "::endgroup::"

      - name: Save spec & event as artifact (triage)
        uses: actions/upload-artifact@v4
        with:
          name: triage-inputs-${{ github.run_id }}
          path: |
            event.json
            spec.json

      # â”€â”€ 3) Optional: gate on 'self-apply' label (can be disabled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Require 'self-apply' label (optional gate)
        if: ${{ env.TRIAGE_REQUIRE_LABEL == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => (typeof l === 'string' ? l : l.name));
            if (!labels.includes('self-apply')) {
              core.notice("Label 'self-apply' not found â€” skipping triage per TRIAGE_REQUIRE_LABEL=true.");
              process.exit(0);
            }

      # â”€â”€ 4) Plan to tasks (non-blocking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Expand to Tasks (Plan Agent)
        run: |
          mkdir -p rocketgpt-agents/out
          node rocketgpt-agents/runners/github_actions.js plan spec.json > rocketgpt-agents/out/tasks.json || true
          echo "Planned tasks:"
          cat rocketgpt-agents/out/tasks.json || true

      # â”€â”€ 5) Comment a summary and ensure label 'codegen:ready' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment planned tasks + add codegen:ready
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;

            const body = [
              "### ðŸ—‚ Planned Tasks",
              "```json",
              `${{ steps.spec.outputs.spec }}`,
              "```",
              "**Next:** Codegen will be triggered automatically."
            ].join("\n");

            // Add comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

            // Add label (note: this alone will NOT trigger other workflows)
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner, repo: context.repo.repo, issue_number
            });
            const has = (issue.labels || []).some(l => (typeof l === 'string' ? l : l.name) === 'codegen:ready');
            if (!has) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                labels: ['codegen:ready']
              });
            }

      # â”€â”€ 6) Dispatch Codegen reliably (requires GH_PAT) with full logs â”€â”€â”€â”€â”€â”€â”€
      - name: Dispatch Codegen (with logs)
        env:
          OWNER:  ${{ github.repository_owner }}
          REPO:   ${{ github.event.repository.name }}
          ISSUE:  ${{ github.event.issue.number }}
          GH_PAT: ${{ secrets.GH_PAT }} # classic PAT with 'repo' + 'workflow' scopes
        run: |
          set -euo pipefail
          if [ -z "${GH_PAT:-}" ]; then
            echo "ERROR: GH_PAT secret not configured. Create a classic PAT with 'repo' and 'workflow' scopes and add it as GH_PAT in repo secrets."
            exit 1
          fi

          echo "::group::Dispatch Request JSON"
          PAYLOAD=$(jq -n --argjson n "$ISSUE" '{event_type:"codegen", client_payload:{issue_number:$n}}')
          echo "$PAYLOAD" | jq -C .
          echo "$PAYLOAD" > dispatch.codegen.req.json
          echo "::endgroup::"

          STATUS=$(curl -s -o dispatch.codegen.resp.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: token ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/dispatches" \
            -d "$PAYLOAD")

          echo "::group::Dispatch Response"
          echo "HTTP: $STATUS"
          jq -C '.' dispatch.codegen.resp.json || cat dispatch.codegen.resp.json
          echo "::endgroup::"

          test "$STATUS" = "204" || (echo "ERR: dispatch failed"; exit 1)

      - name: Save dispatch artifacts (triage)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: triage-dispatch-${{ github.run_id }}
          path: |
            dispatch.codegen.req.json
            dispatch.codegen.resp.json
